<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>sophon — {{.Session.Project}}</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    background: #1a1a2e;
    color: #e0e0e0;
    min-height: 100vh;
    padding: 16px;
  }
  .container { max-width: 480px; margin: 0 auto; }
  .project {
    font-size: 14px;
    color: #8888aa;
    margin-bottom: 12px;
  }
  .context {
    background: #16213e;
    border: 1px solid #2a2a4a;
    border-radius: 8px;
    padding: 12px 16px;
    margin-bottom: 16px;
    font-family: "SF Mono", "Fira Code", monospace;
    font-size: 13px;
    line-height: 1.5;
    white-space: pre-wrap;
    word-break: break-word;
    max-height: 300px;
    overflow-y: auto;
  }
  .quick-buttons {
    display: flex;
    gap: 8px;
    margin-bottom: 16px;
  }
  .quick-buttons button {
    flex: 1;
    padding: 12px 8px;
    border: none;
    border-radius: 8px;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    transition: opacity 0.15s;
  }
  .quick-buttons button:active { opacity: 0.7; }
  .btn-allow { background: #2d6a4f; color: #fff; }
  .btn-allow-all { background: #1b4332; color: #b7e4c7; }
  .btn-deny { background: #6a2d2d; color: #fff; }
  .input-group {
    display: flex;
    gap: 8px;
    margin-bottom: 16px;
  }
  .input-group input {
    flex: 1;
    padding: 12px;
    border: 1px solid #2a2a4a;
    border-radius: 8px;
    background: #16213e;
    color: #e0e0e0;
    font-size: 15px;
    outline: none;
  }
  .input-group input:focus { border-color: #5555aa; }
  .input-group button {
    padding: 12px 20px;
    border: none;
    border-radius: 8px;
    background: #3a3a6a;
    color: #fff;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
  }
  .input-group button:active { opacity: 0.7; }
  .session-state {
    font-size: 13px;
    padding: 8px 12px;
    border-radius: 8px;
    margin-bottom: 12px;
  }
  .session-state.stopped {
    background: #1a2a1a;
    color: #8aaa8a;
  }
  .meta {
    font-size: 12px;
    color: #555577;
    text-align: center;
  }
  .status {
    text-align: center;
    padding: 12px;
    margin-bottom: 16px;
    border-radius: 8px;
    font-size: 14px;
    display: none;
  }
  .status.ok { display: block; background: #1b4332; color: #b7e4c7; }
  .status.err { display: block; background: #6a2d2d; color: #ffc0c0; }

  /* Conversation view */
  #conversation {
    display: flex;
    flex-direction: column;
    gap: 8px;
    max-height: 60vh;
    overflow-y: auto;
    margin-bottom: 16px;
    padding: 4px;
  }
  #conversation:empty { display: none; }
  .conv-empty {
    font-size: 13px;
    color: #555577;
    text-align: center;
    padding: 16px;
  }
  .msg {
    max-width: 85%;
    padding: 8px 12px;
    border-radius: 12px;
    font-size: 14px;
    line-height: 1.4;
    word-break: break-word;
    white-space: pre-wrap;
  }
  .msg.user {
    align-self: flex-end;
    background: #2a4a6e;
    color: #d0e0f0;
    border-bottom-right-radius: 4px;
  }
  .msg.assistant {
    align-self: flex-start;
    background: #2a2a4a;
    color: #d0d0e0;
    border-bottom-left-radius: 4px;
  }
  .msg .tool-use {
    font-family: "SF Mono", "Fira Code", monospace;
    font-size: 12px;
    color: #8888bb;
    padding: 2px 0;
  }
  .ask-question {
    margin-top: 4px;
    white-space: normal;
  }
  .ask-question .question-header {
    font-size: 11px;
    font-weight: 600;
    color: #9999cc;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 4px;
  }
  .ask-question .question-text {
    font-size: 14px;
    color: #d0d0e0;
    margin-bottom: 8px;
  }
  .ask-question .option {
    background: #1a1a3a;
    border: 1px solid #3a3a5a;
    border-radius: 6px;
    padding: 8px 10px;
    margin-bottom: 6px;
  }
  .ask-question .option-label {
    font-weight: 600;
    font-size: 13px;
    color: #c0c0e0;
  }
  .ask-question .option-desc {
    font-size: 12px;
    color: #8888aa;
    margin-top: 2px;
  }
</style>
</head>
<body>
<div class="container">
  <div class="project">{{.Session.Project}}</div>

  {{if .IsStopped}}
  <div class="session-state stopped">Session complete · stopped {{timeAgo .Session.StoppedAt}}</div>
  {{end}}

  <div id="conversation"></div>

  {{if .Session.NotifyMessage}}
  <div class="context">{{.Session.NotifyMessage}}</div>
  {{end}}

  <div id="status" class="status"></div>

  {{if not .IsStopped}}
    {{if .HasPerm}}
    <div class="quick-buttons">
      <button class="btn-allow" onclick="send('y')">Allow</button>
      <button class="btn-allow-all" onclick="send('a')">Always</button>
      <button class="btn-deny" onclick="send('n')">Deny</button>
    </div>
    {{end}}

    <div class="input-group">
      <input type="text" id="text" placeholder="Type a response..." autofocus
             onkeydown="if(event.key==='Enter')sendText()">
      <button onclick="sendText()">Send</button>
    </div>
  {{end}}

  <div class="meta">Session {{.Session.ID}} · {{.TimeAgo}}</div>
</div>

<script>
const apiBase = '{{.BaseURL}}';
const sessionId = '{{.Session.ID}}';

function showStatus(msg, ok) {
  const el = document.getElementById('status');
  el.textContent = msg;
  el.className = 'status ' + (ok ? 'ok' : 'err');
  if (ok) setTimeout(() => { el.className = 'status'; }, 3000);
}

function send(text) {
  fetch(apiBase + '/api/respond/' + sessionId, {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({text: text})
  })
  .then(r => {
    if (r.ok) showStatus('Sent: ' + text, true);
    else r.text().then(t => showStatus('Error: ' + t, false));
  })
  .catch(e => showStatus('Network error: ' + e, false));
}

function sendText() {
  const input = document.getElementById('text');
  const text = input.value.trim();
  if (!text) return;
  send(text);
  input.value = '';
}

function escapeHtml(s) {
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

function renderAskQuestion(input) {
  let html = '';
  const questions = input.questions || [];
  questions.forEach(q => {
    html += '<div class="ask-question">';
    if (q.header) {
      html += '<div class="question-header">' + escapeHtml(q.header) + '</div>';
    }
    html += '<div class="question-text">' + escapeHtml(q.question) + '</div>';
    (q.options || []).forEach((opt, i) => {
      html += '<div class="option">';
      html += '<div class="option-label">' + (i + 1) + '. ' + escapeHtml(opt.label) + '</div>';
      if (opt.description) {
        html += '<div class="option-desc">' + escapeHtml(opt.description) + '</div>';
      }
      html += '</div>';
    });
    html += '</div>';
  });
  return html;
}

function loadTranscript() {
  fetch(apiBase + '/api/sessions/' + sessionId + '/transcript')
    .then(r => r.json())
    .then(data => {
      const el = document.getElementById('conversation');
      const messages = data.messages || [];
      if (messages.length === 0) return;

      let html = '';
      messages.forEach(msg => {
        const cls = msg.role === 'user' ? 'user' : 'assistant';
        let content = '';
        (msg.blocks || []).forEach(b => {
          if (b.type === 'tool_use' && b.text === 'AskUserQuestion' && b.input) {
            content += renderAskQuestion(b.input);
          } else if (b.type === 'tool_use') {
            content += '<div class="tool-use">' + escapeHtml(b.text) + '</div>';
          } else {
            content += escapeHtml(b.text);
          }
        });
        html += '<div class="msg ' + cls + '">' + content + '</div>';
      });
      el.innerHTML = html;
      el.scrollTop = el.scrollHeight;
    })
    .catch(() => {}); // graceful failure
}

loadTranscript();
</script>
</body>
</html>
